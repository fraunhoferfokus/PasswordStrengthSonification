<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>PWSon_DroneSynth.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="module-scripts_EncryptedTransmission-EncryptedTransmission.html">EncryptedTransmission</a><ul class='methods'><li data-type='method'><a href="module-scripts_EncryptedTransmission-EncryptedTransmission.html#init">init</a></li><li data-type='method'><a href="module-scripts_EncryptedTransmission-EncryptedTransmission.html#updateSonification">updateSonification</a></li></ul></li><li><a href="module-scripts_InverseParkingSensor-InverseParkingSensor.html">InverseParkingSensor</a><ul class='methods'><li data-type='method'><a href="module-scripts_InverseParkingSensor-InverseParkingSensor.html#init">init</a></li><li data-type='method'><a href="module-scripts_InverseParkingSensor-InverseParkingSensor.html#updateSonification">updateSonification</a></li></ul></li><li><a href="module-scripts_NoiseToHarmonic-NoiseToHarmonic.html">NoiseToHarmonic</a><ul class='methods'><li data-type='method'><a href="module-scripts_NoiseToHarmonic-NoiseToHarmonic.html#init">init</a></li><li data-type='method'><a href="module-scripts_NoiseToHarmonic-NoiseToHarmonic.html#updateSonification">updateSonification</a></li></ul></li><li><a href="module-scripts_PasswordChecker-PasswordChecker.html">PasswordChecker</a><ul class='methods'><li data-type='method'><a href="module-scripts_PasswordChecker-PasswordChecker.html#checkPwd">checkPwd</a></li><li data-type='method'><a href="module-scripts_PasswordChecker-PasswordChecker.html#init">init</a></li></ul></li><li><a href="module-scripts_PWSon_Base-PWSon_Base.html">PWSon_Base</a><ul class='methods'><li data-type='method'><a href="module-scripts_PWSon_Base-PWSon_Base.html#init">init</a></li><li data-type='method'><a href="module-scripts_PWSon_Base-PWSon_Base.html#muteAudio">muteAudio</a></li><li data-type='method'><a href="module-scripts_PWSon_Base-PWSon_Base.html#playCommonPWEventSound">playCommonPWEventSound</a></li><li data-type='method'><a href="module-scripts_PWSon_Base-PWSon_Base.html#setAudioOutput">setAudioOutput</a></li><li data-type='method'><a href="module-scripts_PWSon_Base-PWSon_Base.html#updateSonification">updateSonification</a></li></ul></li><li><a href="module-scripts_PWSon_DroneSynth-PWSon_DroneSynth.html">PWSon_DroneSynth</a><ul class='methods'><li data-type='method'><a href="module-scripts_PWSon_DroneSynth-PWSon_DroneSynth.html#enableMajorScale">enableMajorScale</a></li><li data-type='method'><a href="module-scripts_PWSon_DroneSynth-PWSon_DroneSynth.html#getOutput">getOutput</a></li><li data-type='method'><a href="module-scripts_PWSon_DroneSynth-PWSon_DroneSynth.html#play">play</a></li><li data-type='method'><a href="module-scripts_PWSon_DroneSynth-PWSon_DroneSynth.html#stop">stop</a></li></ul></li><li><a href="module-scripts_SonificationGroup-SonificationGroup.html">SonificationGroup</a><ul class='methods'><li data-type='method'><a href="module-scripts_SonificationGroup-SonificationGroup.html#addSonification">addSonification</a></li><li data-type='method'><a href="module-scripts_SonificationGroup-SonificationGroup.html#initAllSonifications">initAllSonifications</a></li><li data-type='method'><a href="module-scripts_SonificationGroup-SonificationGroup.html#muteAudio">muteAudio</a></li><li data-type='method'><a href="module-scripts_SonificationGroup-SonificationGroup.html#playCommonPWEventSound">playCommonPWEventSound</a></li><li data-type='method'><a href="module-scripts_SonificationGroup-SonificationGroup.html#selectSonificationByDescription">selectSonificationByDescription</a></li><li data-type='method'><a href="module-scripts_SonificationGroup-SonificationGroup.html#selectSonificationByIndex">selectSonificationByIndex</a></li><li data-type='method'><a href="module-scripts_SonificationGroup-SonificationGroup.html#selectSonificationByObject">selectSonificationByObject</a></li><li data-type='method'><a href="module-scripts_SonificationGroup-SonificationGroup.html#setAllEnableGradualVolumeAtFewCharacters">setAllEnableGradualVolumeAtFewCharacters</a></li><li data-type='method'><a href="module-scripts_SonificationGroup-SonificationGroup.html#setAllFadeInCharacters">setAllFadeInCharacters</a></li><li data-type='method'><a href="module-scripts_SonificationGroup-SonificationGroup.html#setAllGoodEnoughThreshold">setAllGoodEnoughThreshold</a></li><li data-type='method'><a href="module-scripts_SonificationGroup-SonificationGroup.html#setAllReversePolarity">setAllReversePolarity</a></li><li data-type='method'><a href="module-scripts_SonificationGroup-SonificationGroup.html#updateSonification">updateSonification</a></li></ul></li><li><a href="module-scripts_TwoTones-TwoTones.html">TwoTones</a><ul class='methods'><li data-type='method'><a href="module-scripts_TwoTones-TwoTones.html#updateSonification">updateSonification</a></li></ul></li></ul><h3>Modules</h3><ul><li><a href="module-scripts_EncryptedTransmission.html">scripts/EncryptedTransmission</a></li><li><a href="module-scripts_InverseParkingSensor.html">scripts/InverseParkingSensor</a></li><li><a href="module-scripts_NoiseToHarmonic.html">scripts/NoiseToHarmonic</a></li><li><a href="module-scripts_PasswordChecker.html">scripts/PasswordChecker</a></li><li><a href="module-scripts_PWSon_Base.html">scripts/PWSon_Base</a></li><li><a href="module-scripts_PWSon_DroneSynth.html">scripts/PWSon_DroneSynth</a></li><li><a href="module-scripts_PWSon_HelperFunctions.html">scripts/PWSon_HelperFunctions</a><ul class='methods'><li data-type='method'><a href="module-scripts_PWSon_HelperFunctions.html#~attachScriptToHead">attachScriptToHead</a></li><li data-type='method'><a href="module-scripts_PWSon_HelperFunctions.html#~loadScript">loadScript</a></li><li data-type='method'><a href="module-scripts_PWSon_HelperFunctions.html#~rand">rand</a></li><li data-type='method'><a href="module-scripts_PWSon_HelperFunctions.html#~scaleBetweenTwoRanges">scaleBetweenTwoRanges</a></li></ul></li><li><a href="module-scripts_PWSon_SoundFilePaths.html">scripts/PWSon_SoundFilePaths</a></li><li><a href="module-scripts_SonificationGroup.html">scripts/SonificationGroup</a></li><li><a href="module-scripts_TwoTones.html">scripts/TwoTones</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">PWSon_DroneSynth.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/** 
 * Drone Synthesizer module
 * @module
 * @author Otto Hans-Martin Lutz &lt;otto.lutz@fokus.fraunhofer.de>
 */
import { rand } from './PWSon_HelperFunctions.js'
import { convolutionReverbFile } from './PWSon_SoundFilePaths.js'
import 'https://cdnjs.cloudflare.com/ajax/libs/tone/13.8.25/Tone.js'
export { PWSon_DroneSynth }

/**
 * DroneSynth class, provides a drone synthesizer
 */
class PWSon_DroneSynth {
    /** create a drone synthesizer object */
    constructor() {
        this.rmsMeter = new Tone.Meter()
        this.masterGain = new Tone.Gain(2)
        this.masterGain.connect(this.rmsMeter)
        this.reverb = new Tone.Convolver(convolutionReverbFile).connect(this.masterGain)
        this.reverb.wet.value = 0.1
        this.hpFilter = new Tone.Filter(120, "highpass").connect(this.reverb)
        this.hpFilter.rolloff = -24
        this.compressor = new Tone.Compressor().connect(this.hpFilter)
        this.noiseSrc = new Tone.Noise("white");
        this.params = {
            filterQ: 8000,
            rolloff: -48
        }
        this.scale = ["B3", "D3", "F#3", "B4", "D4", "F#4"]//, "B5", "D5", "F#5"]
        this.scalePos = 0
        this.majorScale = false
        this.voices = []


        // populate voices
        for (let i = 0; i &lt; 3; i++) {
            let gain = new Tone.Gain(0.8)
            let panner = new Tone.Panner()

            let filters = [
                new Tone.Frequency(this.scale[i]),
                new Tone.Frequency(this.scale[i]).transpose(+12),
                //new Tone.Frequency(this.scale[i]).transpose(-12)
            ].map(freq => {
                let filter = new Tone.Filter({
                    type: "bandpass",
                    frequency: freq.toFrequency(),
                    Q: this.params.filterQ
                })
                this.noiseSrc.connect(filter)
                filter.connect(gain)
                return filter
            });

            gain.connect(panner)
            panner.connect(this.compressor)
            this.voices[i] = { filters, gain, panner }
        }
    }

    /** return the output object
     * @returns {Object} drone synth output
     */
    getOutput() { return this.masterGain }

    /** @private */
    fluctuate() {
        for (var voice of this.voices) {
            voice.gain.gain.setTargetAtTime(rand(1, 10), Tone.now(), 0.03);
            voice.panner.pan.setTargetAtTime(rand(-0.5, 0.5), Tone.now(), 0.03);
        }
    }

     /** @private */
    adjustGain() {
        if (this.rmsMeter.getLevel() > -16) this.masterGain.gain.value *= 0.95
        //console.log(this.rmsMeter.getLevel() + "\t" + this.masterGain.gain.value)
    }

     /** @private */
    changeScale(incScalePos) {
        if (incScalePos) {
            this.scalePos += 1
            if (this.scalePos >= this.scale.length - 2) this.scalePos = 0
        }
        if (this.majorScale) {
            this.scale = ["B3", "D#3", "F#3", "B4", "D#4", "F#4"]
        }
        else {
            this.scale = ["B3", "D3", "F#3", "B4", "D4", "F#4"]
        }
        for (let i = 0; i &lt; 3; i++) {
            this.voices[i].filters[0].frequency.value = new Tone.Frequency(this.scale[this.scalePos + i])
            this.voices[i].filters[1].frequency.value = new Tone.Frequency(this.scale[this.scalePos + i]).transpose(+12)
        }

    }

     /** start the continuous drone synth */
    play() {
        this.noiseSrc.start()
        this.reverb.wet.value = 0.1
        this.intervalAutoGain = setInterval(() => { this.adjustGain() }, 100)
        this.intervalFluctuate = setInterval(() => { this.fluctuate() }, 200)
        this.intervalChangeScale = setInterval(() => { this.changeScale(true) }, 4000)
    }

    /** stop the drone synth */
    stop() {
        this.noiseSrc.stop()
        this.reverb.wet.value = 0.0
        clearInterval(this.intervalAutoGain)
        clearInterval(this.intervalFluctuate)
        clearInterval(this.intervalChangeScale)
    }

    /** switch between major and minor scale
     * @param {boolean} enable enable major scale
     */
    enableMajorScale(enable) {
        this.majorScale = enable
        this.changeScale(false)
    }
}



</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.4</a> on Wed Jul 01 2020 20:18:06 GMT+0200 (GMT+02:00) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
